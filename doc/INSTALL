UNISON INSTALL NOTES							-*-outline-*-

These notes describe how I (Reece) typically prepare to create or restore
a Unison database.  It's not thorough and you're expected to know
something about installing postgresql and databases.


* Become the db superuser and set a few variables
$ sudo -H -s -u postgres
$ unset PGHOST PGPORT
$ export PGUSER=postgres
$ export PGDATA=/srv/postgresql

* Starting a database cluster for the first time
$ initdb -Upostgres -W -A password --locale=C -D $PGDATA
$ pg_ctl -D $PGDATA -l $PGDATA/postgresql.log start

* configure the cluster
$ psql -d template1 -c "alter user $PGUSER password 'thepass'";
$ GENENTECH: cp conf/{postgresql.conf,pg_hba.conf} $PGDATA/
$ pg_ctl -l $PGDATA/log -D $PGDATA restart
  [NOTE: some distributions have other startup wrappers]

* add unison C functions
$ cd unison/src
$ make unison.so
$ make install

* create users
NOTE: the user 'postgres' must exist and will if you initdb as above (or
have a typical Linux distribution)
$ createuser -i2 -A -D    PUBLIC
$ createuser -i3 -A -D -P unison
$ createuser -i4 -A -D -P loader
$ psql -d template1 -c "alter user unison password 'password'";
$ psql -d template1 -c "alter user loader password 'password'";

$ GENENTECH: sbin/passwd2sql </etc/passwd -g1279,227,199,136,140,201,202,984,81 \
  | psql -Upostgres -hcsb -dtemplate1 -qaf-

* stopping/starting/restarting the database
$ pg_ctl -l $PGDATA/postgresql.log stop
$ pg_ctl -l $PGDATA/postgresql.log start
$ pg_ctl -l $PGDATA/postgresql.log restart

* backups and restore
backups are kept in ~rkh/csb-db/backups/csb-dev/.

Prior to 2005-02-02, full backups are named <timestamp>.pgdump.gz;
schema-only backups are named <timestamp>-s.pgdump.gz. 'pgdump-s' files
are schema-only. Either type may be resotred with psql, like this:
$ gzip -cdq backup.pgdump.gz | psql -dcsb-dev -af- >restore.log 2>&1

Beginning 2005-02-02, I started using pg_dump "custom" format. These are
stored in the same directory. Individual records in the dump are
compressed, but the archive itself is not. See pg_restore for information
on restoring, but it goes something like this:
$ createdb csbA
$ pg_restore -v -dcsbA 2005-02-02-06\:20.pgdump >|csbA.restore 2>&1 &
I /highly/ recommend creating into an empty database with an unlikely db
name to preclude inadvertenly overwritting an existing db.

* setting the default database schema search path:
$ export PGDATABASE=csb-dev
$ psql -c "alter database $PGDATABASE set search_path = '\$user',unison,gong,scop,tax,public";
Note: You should connect to the same database that you're modifying, as above.

