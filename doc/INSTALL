-*-outline-*-

IMPORTANT:
- The database user is compbio. You must become that user for these to work
- make sure that you're using the postgresql tools in
  /apps/compbio/i686-linux-2.4/opt/postgresql/bin/.  It usually suffices
  to have /a/c/i686-linux-2.4/bin/ in your PATH ahead of system bin/
  directories.
- $ export PGDATA=/services/postgresql
- $ unset PGUSER
- $ unset PGHOST


* preparing and starting a database "cluster" (instance of postgresql) for the first time
$ audit compbio
$ unset PGUSER PGDATABASE PGHOST PGPORT
$ initdb -U compbio -D $PGDATA
$ pg_ctl -D $PGDATA start
$ psql -U compbio -d template1 -c "alter user compbio password 'thepass'";
$ cp csb-db/conf/{postgresql.conf,pg_hba.conf} $PGDATA/
$ pg_ctl -l $PGDATA/log -D $PGDATA restart
$ psql -Ucompbio -dtemplate1 -c 'select version()'  ## to test connection
$ createuser -i2 -Ucompbio -A -D    PUBLIC
$ createuser -i3 -Ucompbio -A -D -P unison
$ createuser -i4 -Ucompbio -A -D -P loader
$ csb-db/bin/passwd2sql </etc/passwd rkh cavs wiw ... | psql -dtemplate1 -Uadmin -qaf-


* languages and unison C functions
## This is optional. We're better off doing it for the database itself, NOT template1
$ PGPASSWORD= createlang -dtemplate1 -Uadmin plpgsql
$ PGPASSWORD= createlang -dtemplate1 -Uadmin plperl
$ PGPASSWORD= createlang -dtemplate1 -Uadmin plperlu
$ PGPASSWORD= createlang -dtemplate1 -Uadmin plpython
$ cd csb-db/unison/src
$ make unison.so
$ make install



* (re-)starting the database
$ export PGDATA=/services/postgresql
$ pg_ctl -l$PGDATA/log restart    # works even if not already running


* backups and restoration; csb-dev creation
backups are kept in ~rkh/csb-db/backups/csb/. Full backups are named
<timestamp>.pgdump.gz; schema-only backups are named
<timestamp>-s.pgdump.gz. 

The basic DIY restore is like this:
$ gzip -cdq backup.sql | psql -dcsb-dev -Uadmin -af- >restore.log 2>&1

Instead, use csb-db/bin/restore, like this:
$ PGPASSWORD=xxx PGDATABASE=csb-dev restore <timestamp.pgdump.gz>


* setting the default database schema search path:
$ psql -Uadmin -c "alter database csb set search_path = '\$user',unison,gong,scop,tax,public";
pg_restore -a -v -p5433 -d csb-dev -S compbio -U compbio --disable-triggers --use-set-session-authorization  csb.pgd



* copying a list of users
$ psql -At -dtemplate1 -c 'select usename from pg_user' >|/tmp/logins
(see pg_dumpall -g too)

