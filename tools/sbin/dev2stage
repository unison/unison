#!/bin/sh -e
# copy dev database to stage
# $Id: dev2stage,v 1.1 2004/04/28 21:44:47 rkh Exp $

unset PGDATABASE
export PGUSER=compbio
STAGENAME=$1

echo '# $Id: dev2stage,v 1.1 2004/04/28 21:44:47 rkh Exp $' 1>&2

# attempt to connect to STAGENAME and fail if connection succeeds
if psql -d$STAGENAME </dev/null >/dev/null 2>/dev/null; then
	echo "$STAGENAME already exists; aborting" 1>&2
	exit 1
fi


# create the new database with necessary languages
createdb "$STAGENAME";
createlang -d"$STAGENAME" plpgsql
createlang -d"$STAGENAME" plperl
createlang -d"$STAGENAME" plperlu


# restore selected schemas
SCHEMAS="go scop tax unison"
for s in $SCHEMAS; do
	time -p pg_dump -n "$s" "csb-dev" | psql -d"$STAGENAME" -qaf-
done



psql -d"$STAGENAME" -qaf - <<EOF
alter database "$STAGENAME" set search_path = unison,go,scop,tax;
EOF
