#!/bin/bash
# $Id: backup,v 1.6 2003/04/30 21:09:24 rkh Exp $

# backup -- backup the csb database
# you must set PGPASSWORD before running this script
# any user with write permission in /home/rkh/csb-db/backups/$PGDATABASE
# should be able to run this script.


source `dirname $0`/utils
exec >>"$LOGDIR/$JEMAPPELLE" 2>&1


PATH=/apps/compbio/i686-linux-2.4/bin:/usr/bin:/bin
case `hostname` in
    svc*|td-svc*|interceptor*|td-interceptor*)
    	PGHOST=;;
    *) 
    	PGHOST=td-svc;;
esac

export PGHOST
export PGDATABASE=${1:-csb}


DIR="/home/rkh/csb-db/backups/$PGDATABASE"
mkdir -p "$DIR"
DATE=`date +%Y-%m-%d-%H:%M`;
R="$DIR/$DATE.pgdump"


logger "starting backup (PGHOST=$PGHOST; PGDATABASE=$PGDATABASE)"
(time -p pg_dump -t porigin -X use-set-session-authorization -Uadmin "$PGDATABASE" \
 | gzip -cq) >"$R".gz 2>"$R".err
E="$?"
S=`perl -le 'printf( "%.2f", (-s $ARGV[0]) / 2**20)' "$R".gz`
logger "backup completed; status $E; size: $S MB; time: `tr '\012' , <"$R".err`"
logger "backup log in $R.err"
