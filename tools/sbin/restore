#!/bin/sh

unset PGUSER
unset PGHOST

if [ "`uname -n`" != "interceptor" ]; then
	echo "this is best run on interceptor" 1>&2
	exit 1
fi

if [ -z "$PGPASSWORD" ]; then
	echo "PGPASSWORD isn't set; run like this:" 1>&2
	echo "  PGPASSWORD=blah PGDATABASE=dbname $0" 1>&2
	exit 2
fi
if [ -z "$PGDATABASE" ]; then
	echo "PGDATABASE isn't set; run like this:" 1>&2
	echo "  PGPASSWORD=blah PGDATABASE=dbname $0" 1>&2
	exit 2
fi


if psql -UPUBLIC -d"$PGDATABASE" -c'\q' >/dev/null 2>/dev/null; then
	echo "$PGDATABASE already exists; aborting" 1>&2
	exit 3
fi


psql -Uadmin -dtemplate1 -qaf - <<EOF
create database "$PGDATABASE";
grant create on database "$PGDATABASE" to rkh;
grant create on database "$PGDATABASE" to cavs;
EOF

gzip -cd "$1" \
| psql -Uadmin -d"$PGDATABASE" -qaf -

