#!/usr/bin/env perl
# get-seq -- retrieve sequences from unison
# $Id: get-seq,v 1.5 2003/05/27 22:33:45 rkh Exp $

use warnings;
use strict;
use Unison;
use Getopt::Long qw(:config gnu_getopt);
use Data::Dumper;

my %opts;
GetOptions( \%opts,
			'best-alias|best-oa|a+',
			'best-annotation|best-oad|D+',
			'all-aliases|A+',
			'dnaid|D=s@',
			'proid|P=s@'
		  )
  || die("$0: you got usage issues, homey\n");

my $u = new Unison( username => 'PUBLIC' );
die( "! couldn't open a connection to unison\n" ) unless $u;


@{$opts{proid}} = map {split(/,/,$_)} @{$opts{proid}};
unshift(@ARGV, SPDI_lookup('PRO',@{$opts{proid}}));

@{$opts{dnaid}} = map {split(/,/,$_)} @{$opts{dnaid}};
unshift(@ARGV, SPDI_lookup('DNA',@{$opts{dnaid}}));

if (@ARGV) {
  while( my $r = shift ) {
	eval "process1(\$_) for $r"
  }
} else {
  while (my $id=<>)	{
	process1($id) }
}

exit(0);

############################################################################

sub process1
  {
  my $pseq_id = shift;
  my $seq = get1($pseq_id);
  if (not defined $seq)
	{ warn("Unison:$pseq_id not found\n"); return; }
  print $seq;
  }

sub get1
  {
  my $pseq_id = shift;
  my @aliases;
  my $rv;
  my $seq = $u->get_sequence_by_pseq_id($pseq_id);
  if (not defined $seq)
	{ warn("pseq $pseq_id doesn't exist\n"); return; }
  if (defined $opts{'best-alias'})
	{ (@aliases) = $u->best_alias($pseq_id) }
  elsif (defined $opts{'best-annotation'})
	{ (@aliases) = $u->best_annotation($pseq_id) }
  elsif (defined $opts{'all-aliases'})
	{ (@aliases) = $u->pseq_get_aliases($pseq_id) }
  $rv = join(' ',">Unison:$pseq_id",@aliases) . "\n";
  while( length($seq) )
	{ $rv .= substr($seq,0,60,'') . "\n"; }
  return $rv;
  }



sub SPDI_lookup {
  my $pfx = shift;
  return map {SPDI_lookup1($pfx,$_)} @_;
}

sub SPDI_lookup1 {
  my ($pfx,$id) = @_;
  my $sth = $u->prepare_cached(q/select pseq_id from palias where alias=? and
 								porigin_id=porigin_id_lookup('SPDI')/);
  $sth->execute("$pfx$id");
  my $rv = $sth->fetchrow_array;
  $sth->finish();
  return $rv;
}





=pod

=head1 NAME

get-seq -- retrieve sequences from Unison

S<$Id: get-seq,v 1.5 2003/05/27 22:33:45 rkh Exp $>

=head1 SYNOPSIS

 get-seq [-a|-A|-D] [pseq_id ...]

=head1 OPTIONS

=item B<--alpha> level, B<--Arpha> level, B<-a> level

=head1 DESCRIPTION

B<get-seq> writes selected sequences from Unison in fasta format to
STDOUT, optionally with aliases or annotations.

=cut
