#!/usr/bin/env perl
# load fasta sequences into unison
# $ load-fasta -o origin <fastafile

$^W++;
use strict;
use IO::File;
use Bio::SeqIO;
use Getopt::Long qw(:config gnu_getopt);
use DBI;

use lib ('./perl5', '/home/rkh/unison/perl5', "$ENV{HOME}/unison/perl5");
use Genentech::Unison;


my $origin;
my $filelist;
my $startafter;
my $maxlen = 10000;
GetOptions( 'origin|o=s' => \$origin,
			'filelist|f=s' => \$filelist,
			'startafter|A=s' => \$startafter,
			'maxlen|L=s' => \$maxlen,
			@Genentech::Unison::OPTS
		  )
  || die("$0: bad usage\n");
defined $origin
  || die("$0: --origin (-o) is mandatory\n");


# whee... globals
my $udb = new Genentech::Unison;
my $porigin_id = $udb->si_porigin_id($origin);
my %extant = map {$_=>1} $udb->get_alias_in_porigin_id($porigin_id);
printf(STDERR "# loading sequences into $origin (porigin_id=$porigin_id)\n");



if (defined $filelist)
  {
  my $fh = new IO::File;
  $fh->open("<$filelist")
	|| die("$filelist: $!\n");
  while( my $fn = <$fh> )
	{
	my $in  = Bio::SeqIO->new('-format' => 'Fasta', '-file'=>$fn );
	process_stream($in);
	}
  $fh->close();
  }
elsif (@ARGV)
  {
  while( @ARGV )
	{
	my $in  = Bio::SeqIO->new('-format' => 'Fasta', '-file'=>shift );
	process_stream($in);
	}
  }
else
  {
  my $in = Bio::SeqIO->new('-format' => 'Fasta');
  process_stream($in);
  }

exit(0);




sub process_stream
  {
  my $in = shift;
  while( my $seq = $in->next_seq() )
	{ process_seq($seq); }
  }

sub process_seq
  {
  my $bs = shift;
  my $id = $bs->display_id();
  my $descr = $bs->desc();
  my $seq = $bs->seq();

  # description reformatting
  $descr = '' unless defined $descr;
  $descr =~ s/\s+//g;
  $descr =~ s/^\s+//;
  $descr =~ s/\s+$//;
  if ($origin eq 'SPDI')
	{
	$descr =~ s/\[min\]\s+//;
	$descr =~ s/\# converted.+//;
	}

  # skip sequences in various conditions
  my $skip;
  if ($id !~ m/\w/)
	{ $skip = "doesn't look like a valid sequence id"; }
  elsif (defined $startafter)
	{
	$skip = "haven't reached $startafter yet";
	undef $startafter if ($id eq $startafter);
	}
  elsif (defined %extant and exists $extant{$id})
	{ $skip = "extant"; }
  elsif (defined $maxlen and length($seq)>$maxlen)
	{ $skip = sprintf("too long (%d AA; maxlen=$maxlen",length($seq)); }
  elsif (length($seq) == 0)
	{ $skip = "zero-length"; }
  elsif ($descr =~ m%/type=(\w+)% and $1 ne 'gene')
	{ $skip = "non-gene genescan transcript"; }
  if (defined $skip)
	{ warn("# skipping $id: $skip ($descr)\n"); return; }

  # @ids is the SET of ids to which we'll link this sequence
  my @ids = ();
  if ($origin eq 'SPDI')
	{
	push(@ids,$1) if $descr =~ s/(UNQ\d+)\s+//;
	push(@ids,$1) if $descr =~ s/(PRO\d+)\s+//;
	push(@ids,$1) if $descr =~ s/(DNA\d+)\s+//;
	warn("$id: didn't match 3 SPDI identifiers (@ids)\n") unless $#ids=2;
    }
  else
	{
	@ids = ( $id );
	}

  # select/insert sequences, then link aliases
  my $pseq_id = $udb->si_pseq_id($bs->seq());
  if (not defined $pseq_id)
	{ warn("failed to add $id"); return; }
  foreach my $upd_id (@ids)
	{ $udb->add_palias($pseq_id,$porigin_id,$upd_id,$descr); }

  printf(STDERR "# added pseq_id=$pseq_id, len=%d, aliases={@ids}, descr=%s\n",
		length($seq), $descr);
  }
