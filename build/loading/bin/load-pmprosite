#!/usr/bin/env perl

my $usage = <<'EOU';
#-------------------------------------------------------------------------------
# NAME: load-pmprosite
# PURPOSE: load prosite patterns into Unison
# USAGE: load-pmprosite ARGUMENTS OPTIONS <patterns file ...>
# ARGUMENTS (required):
#   --origin|-o <origin>: name of origin
# OPTIONS:
#   --verbose|-v: flag to output more processing information
#
# $Id: load-pmprosite,v 1.3 2006/06/29 17:25:38 mukhyala Exp $
#------------------------------------------------------------------------------
EOU

use Getopt::Long;
use ps_scan::Prosite;
use Unison;

use strict;
use warnings;



my %opts = (
			'origin' => undef,
			'verbose' => 0,
);
GetOptions( \%opts,
			'origin|o=s',
			'verbose|v')
  || die("$0: bad usage:\n$usage\n");

(defined $opts{origin})
  || die("$0: --origin (-o) is mandatory\n\n$usage");

my $u = new Unison( dbname=>'csb-dev', user=>'loader');

my $origin_id = $u->origin_si_origin_id($opts{origin});
(defined $origin_id)
  || die("$0: origin $opts{origin}: $@\n");
printf(STDERR "# loading patterns from $opts{origin} (origin_id=$origin_id)\n") if($opts{verbose});

my @fn = $u->selectrow_array("select data_url from origin where origin_id=$origin_id");
open (PRO, $fn[0]) || die "Cannot open $fn[0]\n";

my @insert_fields = qw(origin_id acc name descr regexp);

my $insert_stmt = sprintf('insert into pmregexp (%s) values (%s)',
						  join(',',@insert_fields),
						  join(',',map {'?'} @insert_fields) );
my $sth_insert_pmprosite = $u->prepare($insert_stmt);

warn($insert_stmt);

$/ = "\n//\n";
$u->begin_work();
while(my $blk = <PRO>) {

  my @p = Prosite::parseProsite($blk);
  if($p[0] and $p[2] eq 'PATTERN') {
    my ($acc,$name,$descr,$regexp,$skip) = (@p[0..1],$p[3],Prosite::prositeToRegexp($p[4]),$p[7]);
    $sth_insert_pmprosite->execute($origin_id,$acc,$name,$descr,$regexp) if(not $skip);
    print(STDERR "$acc: $name ($descr) : $regexp\n");
  }
}
printf("done; last updated=%s\n", $u->origin_last_updated($origin_id,1));
print("Committing...\n");
$u->commit();
close(PRO);
