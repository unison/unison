#!/usr/bin/env perl

use warnings;
use strict;
use lib ('.', "$ENV{HOME}/unison/perl5");
use Unison;
use Genentech::Utils qw( tmdetect );

my $fn = "/tmp/$$";
my $u = new Unison;

my $pft = $u->get_pftype_id('EMBOSS/sigcleave');
die("EMBOSS/sigcleave feature type doesn't exist\n") unless defined $pft_id;

my $sth = $u->prepare('insert into pfeature (pseq_id,pftype_id,start,stop,quality) values (?,?,?,?,?)');

my @pseq_ids = $u->pseq_ids_without_feature_types($pft);
printf( STDERR "%d sequences need tmdetect'ing\n", $#pseq_ids+1);
foreach my $pseq_id ( @pseq_ids )
  {
  my $n = add_tmdetect_feature( $pseq_id );
  print( STDERR "tmdetect: $pseq_id...$n features\n");
  }


sub add_tmdetect_feature
  {
  my $pseq_id = shift;
  my $seq = $u->get_seq($pseq_id);
  my @tmd = tmdetect( $seq );
  foreach my $tmd (@tmd)
	{
	my @tmd = @$tmd;
	my $pft = $tmd[0] eq 'S' ? $tmds_id : $tmdtm_id;
	my $b = $tmd[1]-10 < 1 ? 1 : $tmd[1]-10;
	$sth->execute( $pseq_id, $pft, $b, $tmd[1]+10, $tmd[2]);
	}
  return $#tmd+1;
  }
