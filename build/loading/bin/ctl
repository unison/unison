#!/bin/sh

DB=unison
ROOT=/home/rkh/$DB
PGDATA=$ROOT/data/
PORT=5432
LOCKFILE=/tmp/.s.PGSQL.$PORT.lock
export LD_LIBRARY_PATH=$ROOT/lib

PATH=/home/rkh/opt/$PLATFORM/bin:/usr/bin:/bin


get_pid()  { head -1 $LOCKFILE 2>/dev/null; }

case $1 in
	init)
		initdb -D $PGDATA
		cp $ROOT/conf/*.conf $PGDATA
		;;
	start)
		(set -x; postmaster -D $PGDATA >>$PGDATA/log 2>&1) &
		sleep 2;
		if [ ! -f $LOCKFILE ]; then
			echo "startup failed (after 2 seconds); from $PGDATA/log:"
			tail $PGDATA/log | nl
			exit 1
		fi
		echo "startup okay: " `cat $LOCKFILE`
		;;
	stop)
		PID=`get_pid`
		if [ -z "$PID" ]; then
			echo "doesn't look like postgresql is running on port $PORT"
			exit 1
		fi
		echo -n "killing $PID..."
		kill $PID
		sleep 5
		if [ -f $LOCKFILE ]; then
			echo "shutdown failed (after 2 seconds)"
			exit 1
		fi
		echo "postgresql is dead"
		;;
	reload)
		PID=`get_pid`
		if [ -z "$PID" ]; then
			echo "doesn't look like postgresql is running on port $PORT"
			exit 1
		fi
		echo -n "giving $PID a swift kick in the arse..."
		kill -HUP $PID
		echo done
		;;
esac

exit 0

	
